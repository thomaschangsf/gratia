GET ebay-n/listing/_search
{
  "size": 1,
  "fields": ["title","leaf_categ_id","attr_cls_keys","attr_ner_keys","attr_seller_keys"], 
  "query": {
    "function_score": {
      "query": {
        "bool": {
          "must": [
            {
              "match": {
                "title": "shoe"
              }
            }
          ],
          "filter": {
            "bool": {
              "must": [
                {
                  "terms": {
                    "leaf_categ_id": [
                      40892,
                      11501,
                      93825
                    ]
                  }
                },
                {
                  "multi_match": {
                    "query": "color:red",
                    "fields": [
                      "attr_ner_keys",
                      "attr_seller_keys",
                      "attr_cls_keys"
                    ]
                  }
                },
                {
                  "multi_match": {
                    "query": "age_group:adult",
                    "fields": [
                      "attr_ner_keys",
                      "attr_seller_keys",
                      "attr_cls_keys"
                    ]
                  }
                }
              ]
            }
          }
        }
      },
      "functions": [
        {
          "filter": {
            "term": {
              "leaf_categ_id": 40892
            }
          },
          "weight": 0.9
        },
        {
          "filter": {
            "term": {
              "leaf_categ_id": 11501
            }
          },
          "weight": 0.8
        },
        {
          "filter": {
            "term": {
              "leaf_categ_id": 93825
            }
          },
          "weight": 0.7
        }
      ]
    }
  },
  "aggs": {
    "sample": {
      "sampler": {
        "shard_size": 100,
        "field": "item_id"
      },
      "aggs": {
        "attr_cls_stats": {
          "terms": {
            "field": "attr_cls_keys",
            "size": 10
          }
        }
      }
    }
  },
  "rescore": {
    "rescore": {
      "window_size": 20,
      "query": {
        "rescore_query": {
          "function_score": {
            "script_score": {
              "params": {
                "query_v": [
                  0.6630087969335081,
                  0.971746423541562,
                  0.8269596598588105,
                  0.45725968947822815,
                  0.7742563034791757,
                  0.6278572634205866,
                  0.2729086042498641,
                  0.6463801201489704,
                  0.17534276841320917,
                  0.7557858337238397,
                  0.9076741762626458,
                  0.619243222850828,
                  0.7338783377317615,
                  0.10700809367434028,
                  0.7855386623861661,
                  0.18968346756329757,
                  0.20011862079570386,
                  0.3922714151397867,
                  0.8623508853596628,
                  0.3991083452394736,
                  0.8437736975023016,
                  0.5648184406300713,
                  0.47471231316519935,
                  0.7349226473223414,
                  0.24176544209819595,
                  0.38142863673137717,
                  0.20340325428122352,
                  0.34895335332167465,
                  0.06852656298722293,
                  0.7366696519773335,
                  0.34031812350255686,
                  0.6272247591752022,
                  0.23359813873123736,
                  0.5479763350083066,
                  0.31196733463088233,
                  0.010283435508278815,
                  0.7356970019826565,
                  0.032652955199762856,
                  0.5776431315837188,
                  0.7923757301219156,
                  0.15808810346945723,
                  0.06261977043624412,
                  0.7166349704535971,
                  0.7381310861326527,
                  0.8170110353592969,
                  0.9087021965486777,
                  0.6464198025979484,
                  0.7470062508566457,
                  0.1930741030511557,
                  0.09348734905579648,
                  0.1725411156462262,
                  0.4685971149665066,
                  0.4249435129653183,
                  0.2602487396623102,
                  0.36093014525167977,
                  0.7260266552691351,
                  0.3253188696849829,
                  0.9351676079378657,
                  0.5447113085376911,
                  0.8399682592782073,
                  0.5911005005428521,
                  0.8110544462961635,
                  0.13007322491693507,
                  0.46246646151026094,
                  0.62281856829843,
                  0.7130023962541171,
                  0.749575727621502,
                  0.327567558386329,
                  0.6428070773061105,
                  0.7198792465005606,
                  0.7263021937863121,
                  0.40487478859115433,
                  0.6072708100708657,
                  0.010292753710693603,
                  0.2585558687184454,
                  0.30249416102596216,
                  0.7443070286998275,
                  0.8776393622719103,
                  0.21233736446272256,
                  0.4074383579489502,
                  0.41810746766443396,
                  0.016073663993050435,
                  0.9176304389154841,
                  0.17440831569859339,
                  0.41898069906455015,
                  0.6177125057492442,
                  0.9045612759920665,
                  0.17797270535275944,
                  0.7094989089192807,
                  0.041113700682307464,
                  0.08678629149183215,
                  0.028518132366693538,
                  0.11898688523042289,
                  0.8120463767528675,
                  0.5020021819094772,
                  0.018943469045122563,
                  0.47173549464449216,
                  0.4997963169857025,
                  0.35326101952999645,
                  0.41692420093995153,
                  0.1587356094607033,
                  0.5757264454605522,
                  0.7598122892869331,
                  0.646673476350084,
                  0.21839290511715048,
                  0.7055385210700555,
                  0.32248315908261826,
                  0.21447843884745443,
                  0.5785975261067824,
                  0.05265975480004936,
                  0.3361465897570013,
                  0.12389227857630869,
                  0.23068726758075664,
                  0.0774034573728325,
                  0.2406165972411639,
                  0.6993132456921723,
                  0.7552563906140156,
                  0.005030378176059114,
                  0.69134909578825,
                  0.19078420662366968,
                  0.8004266270036864,
                  0.6055630901651351,
                  0.4526149944162656,
                  0.2681974192384311,
                  0.8251109785394876,
                  0.1791833043633393,
                  0.16835240514348127,
                  0.5296910383281824,
                  0.6629647249383482,
                  0.6732673085755257,
                  0.9496929130333134,
                  0.4468749181793168,
                  0.23713242873560014,
                  0.670592780064862,
                  0.633196684090002,
                  0.7486259236484197,
                  0.06156353188416108,
                  0.5829754034798582,
                  0.5101195588106415,
                  0.10554282907714418,
                  0.0015834505146712363,
                  0.7605712486673494,
                  0.30457487891217583,
                  0.11875451716725349,
                  0.13457075876534208,
                  0.38430673465492105,
                  0.18724167036172124,
                  0.03962468997915902,
                  0.45100564461991777,
                  0.9473753999808365,
                  0.6513097024030925,
                  0.3509995691312846,
                  0.5668184278481722,
                  0.8514661437202932,
                  0.14864142603580055,
                  0.3259954908487043,
                  0.5798810723442017,
                  0.14436537263704363,
                  0.4866692421384975,
                  0.9469254087895458,
                  0.6966490788860182,
                  0.707800983420283,
                  0.12033620921220445,
                  0.11481470447969533,
                  0.2793744790841095,
                  0.267873437668692,
                  0.6384271171894295,
                  0.9090583849893241,
                  0.5199755045522656,
                  0.4451455348371872,
                  0.9399257507854509,
                  0.767123183746896,
                  0.033562120406226414,
                  0.6874384657148668,
                  0.8235735010854885,
                  0.8457996307354628,
                  0.28278046428956793,
                  0.335609526625549,
                  0.9725935273092983,
                  0.4983608525545459,
                  0.8935539917939479,
                  0.2610622009007557,
                  0.606583302763628,
                  0.7560863880343416,
                  0.6034626208128564,
                  0.48346647570458734,
                  0.39386831351648954,
                  0.937960720862027,
                  0.7959151344802083,
                  0.9281439493106709,
                  0.5701476668522041,
                  0.02895804366206034,
                  0.31643497703116363,
                  0.014798481542089847,
                  0.5930523131968926,
                  0.2651760244892494,
                  0.5417924832583416,
                  0.08274969765210483,
                  0.07727521168504337,
                  0.4431832537390542
                ]
              },
              "script": "sumQ = query_v.collect{x -> x*x}.sum(); sumL = _source.semantic_v.collect{x -> x*x}.sum(); sumQL = [_source.semantic_v, query_v].transpose().collect{ xx, yy -> xx * yy }.sum(); return sumQL/Math.sqrt(sumQ*sumL)"
            }
          }
        },
        "query_weight": 1,
        "rescore_query_weight": 50
      }
    }
  }
}
